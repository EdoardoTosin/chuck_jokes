name: Flutter Build and Release APK

on:
 push:
   tags:
     - '*'

jobs:
 build:
   runs-on: ubuntu-latest

   steps:
   - uses: actions/checkout@v3

   - name: Set up JDK
     uses: actions/setup-java@v4
     with:
       distribution: 'adopt'
       java-version: '17'

   - name: Setup Dart SDK
     uses: dart-lang/setup-dart@v1
     with:
       sdk: stable

   - name: Install Flutter
     uses: subosito/flutter-action@v2
     with:
       channel: 'stable'

   - name: Get dependencies
     run: flutter pub get

   #- name: Run tests
    #run: flutter test

   - name: Build APK
     run: flutter build apk --split-per-abi

   - name: Create a Release
     uses: elgohr/Github-Release-Action@v5
     env:
       GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
     with:
       title: MyReleaseMessage

   - name: Upload APK
     uses: softprops/action-gh-release@v1
     with:
       files: './build/app/outputs/flutter-apk/release/*.apk'
     env:
       GH_REPO: ${{ github.repository }}
       GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
       GH_RELEASE: ${{ github.ref }}
