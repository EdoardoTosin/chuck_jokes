name: Flutter Build and Release APK

on:
 push:
   tags:
     - '*'

jobs:
 build:
   runs-on: ubuntu-latest

   steps:
   - uses: actions/checkout@v3

   - name: Set up JDK
     uses: actions/setup-java@v4
     with:
       distribution: 'adopt'
       java-version: '21'

   - name: Setup Dart SDK
     uses: dart-lang/setup-dart@v1
     with:
       sdk: stable

   - name: Install Flutter
     uses: subosito/flutter-action@v2
     with:
       flutter-version: '3.1.1'

   - name: Get dependencies
     run: flutter pub get

   - name: Run tests
     run: flutter test

   - name: Build APK
     run: flutter build apk --split-per-abi

   - name: Upload APK
     uses: actions/upload-release-asset@v1
     env:
       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
     with:
       upload_url: ${{ github.event.release.upload_url }}
       asset_path: ./build/app/outputs/flutter-apk/release/*.apk
       asset_name: Chuck-Norris.apk
       asset_content_type: application/vnd.android.package-archive